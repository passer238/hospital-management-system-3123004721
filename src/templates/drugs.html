{% extends 'base.html' %}

{% block content %}
<div class="row mb-4 align-items-center">
    <div class="col">
        <h2 class="fw-bold mb-0 text-primary"><i class="bi bi-capsule me-2"></i>药品管理</h2>
    </div>
    <div class="col-auto">
        <span class="badge bg-danger-subtle text-danger-emphasis fs-6 rounded-pill px-3">{{ drugs|length }} 种药品在库</span>
    </div>
</div>

<div class="card shadow-sm mb-4">
    <div class="card-header bg-white border-bottom-0 pt-4 pb-0">
        <h5 class="fw-bold text-primary mb-0"><i class="bi bi-plus-circle me-2"></i>新增药品</h5>
    </div>
    <div class="card-body">
        <form method="POST" action="{{ url_for('drugs') }}">
            <div class="row g-3 mb-3">
                <div class="col-md-2">
                    <div class="form-floating">
                        <input type="text" class="form-control" name="drug_id" id="new_drug_id" placeholder="药品编号"
                            required>
                        <label for="new_drug_id">药品编号</label>
                    </div>
                </div>
                <div class="col-md-3">
                    <div class="form-floating">
                        <input type="text" class="form-control" name="drug_name" id="new_drug_name" placeholder="药品名称"
                            required>
                        <label for="new_drug_name">药品名称</label>
                    </div>
                </div>
                <div class="col-md-2">
                    <div class="form-floating">
                        <input type="number" step="0.01" class="form-control" name="drug_price" id="new_drug_price"
                            placeholder="价格" required>
                        <label for="new_drug_price">价格 (¥)</label>
                    </div>
                </div>
                <div class="col-md-2">
                    <div class="form-floating">
                        <input type="number" class="form-control" name="drug_quantity" id="new_drug_quantity"
                            placeholder="数量" required>
                        <label for="new_drug_quantity">数量</label>
                    </div>
                </div>
                <div class="col-md-3">
                    <div class="form-floating">
                        <input type="text" class="form-control" name="drug_storage" id="new_drug_storage"
                            placeholder="存储位置" required>
                        <label for="new_drug_storage">存储位置</label>
                    </div>
                </div>
            </div>
            <div class="row g-3 mb-3">
                <div class="col-md-6">
                    <div class="form-floating">
                        <input type="date" class="form-control" name="drug_date" id="new_drug_date" required>
                        <label for="new_drug_date">生产日期</label>
                    </div>
                </div>
                <div class="col-md-6">
                    <div class="form-floating">
                        <input type="date" class="form-control" name="usefull_life" id="new_usefull_life" required>
                        <label for="new_usefull_life">有效期至</label>
                    </div>
                </div>
            </div>
            <div class="text-end">
                <button type="submit" class="btn btn-primary px-4"><i class="bi bi-box-seam me-1"></i>添加药品</button>
            </div>
        </form>
    </div>
</div>

<div class="card shadow-sm">
    <div class="card-header bg-white pt-4 pb-2">
        <h5 class="fw-bold text-primary mb-0"><i class="bi bi-list-ul me-2"></i>药品列表</h5>
    </div>
    <div class="card-body">
        <div class="table-responsive">
            <table class="table table-hover align-middle">
                <thead>
                    <tr>
                        <th>编号</th>
                        <th>名称</th>
                        <th>价格</th>
                        <th>数量</th>
                        <th>存储位置</th>
                        <th>生产日期</th>
                        <th>有效期</th>
                        <th class="text-end">操作</th>
                    </tr>
                </thead>
                <tbody>
                    {% for d in drugs %}
                    <tr>
                        <td class="font-monospace text-muted">{{ d.drug_id }}</td>
                        <td class="fw-medium text-dark">{{ d.drug_name }}</td>
                        <td class="text-primary fw-bold">¥{{ d.drug_price }}</td>
                        <td>
                            {% if d.drug_quantity < 10 %} <span class="badge bg-danger rounded-pill">{{ d.drug_quantity
                                }} (由低)</span>
                                {% else %}
                                <span class="badge bg-success-subtle text-success-emphasis rounded-pill">{{
                                    d.drug_quantity }}</span>
                                {% endif %}
                        </td>
                        <td><small>{{ d.drug_storage }}</small></td>
                        <td class="text-muted small">{{ d.drug_date or '-' }}</td>
                        <td class="text-muted small">{{ d.usefull_life or '-' }}</td>
                        <td class="text-end">
                            <div class="btn-group">
                                <button type="button" class="btn btn-outline-warning btn-sm"
                                    onclick="editDrug('{{ d.drug_id }}', '{{ d.drug_name }}', {{ d.drug_price }}, {{ d.drug_quantity }}, '{{ d.drug_storage }}')">
                                    <i class="bi bi-pencil"></i>
                                </button>
                                <button type="button" class="btn btn-outline-danger btn-sm"
                                    onclick="confirmDelete('{{ url_for('delete_drug', id=d.drug_id) }}', '确定要删除药品 <strong>{{ d.drug_name }}</strong> 吗？')">
                                    <i class="bi bi-trash"></i>
                                </button>
                            </div>
                        </td>
                    </tr>
                    {% endfor %}
                </tbody>
            </table>
        </div>
    </div>
</div>

<!-- 编辑药品模态框 -->
<div class="modal fade" id="editDrugModal" tabindex="-1">
    <div class="modal-dialog modal-dialog-centered">
        <div class="modal-content border-0 shadow-lg">
            <div class="modal-header bg-primary text-white">
                <h5 class="modal-title"><i class="bi bi-pencil-square me-2"></i>编辑药品信息</h5>
                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
            </div>
            <form method="POST" action="{{ url_for('edit_drug_submit') }}">
                <div class="modal-body p-4">
                    <input type="hidden" name="drug_id" id="edit_drug_id">
                    <div class="row g-3">
                        <div class="col-12">
                            <label class="form-label text-muted small text-uppercase fw-bold">药品名称</label>
                            <input type="text" class="form-control" name="drug_name" id="edit_drug_name" required>
                        </div>
                        <div class="col-md-6">
                            <label class="form-label text-muted small text-uppercase fw-bold">价格 (¥)</label>
                            <input type="number" step="0.01" class="form-control" name="drug_price" id="edit_drug_price"
                                required>
                        </div>
                        <div class="col-md-6">
                            <label class="form-label text-muted small text-uppercase fw-bold">库存数量</label>
                            <input type="number" class="form-control" name="drug_quantity" id="edit_drug_quantity"
                                required>
                        </div>
                        <div class="col-12">
                            <label class="form-label text-muted small text-uppercase fw-bold">存储位置</label>
                            <input type="text" class="form-control" name="drug_storage" id="edit_drug_storage" required>
                        </div>
                    </div>
                </div>
                <div class="modal-footer bg-light">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">取消</button>
                    <button type="submit" class="btn btn-primary px-4">保存修改</button>
                </div>
            </form>
        </div>
    </div>
</div>

<script>
    function editDrug(id, name, price, quantity, storage) {
        document.getElementById('edit_drug_id').value = id;
        document.getElementById('edit_drug_name').value = name;
        document.getElementById('edit_drug_price').value = price;
        document.getElementById('edit_drug_quantity').value = quantity;
        document.getElementById('edit_drug_storage').value = storage;

        new bootstrap.Modal(document.getElementById('editDrugModal')).show();
    }
</script>
{% endblock %}