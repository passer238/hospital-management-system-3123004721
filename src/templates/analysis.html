{% extends 'base.html' %}

{% block content %}
<div class="row mb-4 align-items-center">
    <div class="col">
        <h2 class="fw-bold mb-0 text-primary"><i class="bi bi-bar-chart-line me-2"></i>数据统计分析</h2>
    </div>
    <div class="col-auto text-muted">
        <i class="bi bi-clock me-1"></i> 数据实时更新
    </div>
</div>

<!-- 概览统计卡片 -->
<style>
    .stat-card {
        transition: transform 0.2s, box-shadow 0.2s;
        border: none;
    }

    .stat-card:hover {
        transform: translateY(-5px);
        box-shadow: 0 .5rem 1rem rgba(0, 0, 0, .15) !important;
    }

    .stat-icon {
        width: 3rem;
        height: 3rem;
        display: flex;
        align-items: center;
        justify-content: center;
        border-radius: 0.5rem;
        font-size: 1.5rem;
    }
</style>

<div class="row mb-4 g-3">
    <div class="col-md-3">
        <a href="{{ url_for('patients') }}" class="text-decoration-none">
            <div class="card h-100 shadow-sm stat-card">
                <div class="card-body d-flex align-items-center">
                    <div class="stat-icon bg-primary text-white me-3">
                        <i class="bi bi-people-fill"></i>
                    </div>
                    <div>
                        <h6 class="card-subtitle text-muted mb-1">病人总数</h6>
                        <h2 class="card-title fw-bold text-dark mb-0">{{ stats.total_patients }}</h2>
                    </div>
                </div>
            </div>
        </a>
    </div>
    <div class="col-md-3">
        <a href="{{ url_for('doctors') }}" class="text-decoration-none">
            <div class="card h-100 shadow-sm stat-card">
                <div class="card-body d-flex align-items-center">
                    <div class="stat-icon bg-success text-white me-3">
                        <i class="bi bi-person-badge-fill"></i>
                    </div>
                    <div>
                        <h6 class="card-subtitle text-muted mb-1">医生总数</h6>
                        <h2 class="card-title fw-bold text-dark mb-0">{{ stats.total_doctors }}</h2>
                    </div>
                </div>
            </div>
        </a>
    </div>
    <div class="col-md-3">
        <a href="{{ url_for('drugs') }}" class="text-decoration-none">
            <div class="card h-100 shadow-sm stat-card">
                <div class="card-body d-flex align-items-center">
                    <div class="stat-icon bg-info text-white me-3">
                        <i class="bi bi-capsule-pill"></i>
                    </div>
                    <div>
                        <h6 class="card-subtitle text-muted mb-1">药品种类</h6>
                        <h2 class="card-title fw-bold text-dark mb-0">{{ stats.total_drugs }}</h2>
                    </div>
                </div>
            </div>
        </a>
    </div>
    <div class="col-md-3">
        <a href="{{ url_for('registration') }}" class="text-decoration-none">
            <div class="card h-100 shadow-sm stat-card">
                <div class="card-body d-flex align-items-center">
                    <div class="stat-icon bg-warning text-dark me-3">
                        <i class="bi bi-calendar-check-fill"></i>
                    </div>
                    <div>
                        <h6 class="card-subtitle text-muted mb-1">今日挂号</h6>
                        <h2 class="card-title fw-bold text-dark mb-0">{{ stats.today_registrations }}</h2>
                    </div>
                </div>
            </div>
        </a>
    </div>
</div>

<!-- 待处理事项提醒 -->
{% if stats.pending_prescriptions > 0 or stats.pending_payments > 0 or stats.pending_pickups > 0 %}
<div class="card border-0 shadow-sm mb-4 border-start border-warning border-5 bg-warning-subtle">
    <div class="card-body py-3">
        <div class="d-flex align-items-center mb-2">
            <i class="bi bi-exclamation-triangle-fill text-warning fs-4 me-2"></i>
            <h5 class="card-title mb-0 fw-bold text-warning-emphasis">待处理事项提醒</h5>
        </div>
        <div class="row g-3">
            {% if stats.pending_prescriptions > 0 %}
            <div class="col-md-4">
                <div class="bg-white p-2 rounded shadow-sm d-flex align-items-center">
                    <i class="bi bi-file-medical text-primary me-2 fs-5"></i>
                    <a href="{{ url_for('prescriptions') }}" class="text-decoration-none text-dark stretched-link">
                        <strong>{{ stats.pending_prescriptions }}</strong> 条挂号待开处方
                    </a>
                </div>
            </div>
            {% endif %}
            {% if stats.pending_payments > 0 %}
            <div class="col-md-4">
                <div class="bg-white p-2 rounded shadow-sm d-flex align-items-center">
                    <i class="bi bi-credit-card text-success me-2 fs-5"></i>
                    <a href="{{ url_for('payments') }}" class="text-decoration-none text-dark stretched-link">
                        <strong>{{ stats.pending_payments }}</strong> 条收费待支付
                    </a>
                </div>
            </div>
            {% endif %}
            {% if stats.pending_pickups > 0 %}
            <div class="col-md-4">
                <div class="bg-white p-2 rounded shadow-sm d-flex align-items-center">
                    <i class="bi bi-bag-check text-warning me-2 fs-5"></i>
                    <a href="{{ url_for('pickups') }}" class="text-decoration-none text-dark stretched-link">
                        <strong>{{ stats.pending_pickups }}</strong> 条取药票单待取药
                    </a>
                </div>
            </div>
            {% endif %}
        </div>
    </div>
</div>
{% endif %}

<!-- 业务统计 -->
<div class="row mb-4 g-4">
    <div class="col-md-6">
        <div class="card shadow-sm border-0 h-100">
            <div class="card-header bg-white pt-3 pb-2 border-bottom-0">
                <h5 class="fw-bold text-primary mb-0"><i class="bi bi-bar-chart-fill me-2"></i>挂号统计</h5>
            </div>
            <div class="card-body pt-0">
                <table class="table table-hover align-middle mb-0">
                    <tbody>
                        <tr>
                            <td class="text-muted">总挂号数</td>
                            <td class="text-end fs-5 fw-bold text-dark">{{ stats.total_registrations }}</td>
                        </tr>
                        <tr>
                            <td class="text-muted">本月挂号</td>
                            <td class="text-end fs-5 fw-bold text-primary">{{ stats.month_registrations }}</td>
                        </tr>
                        <tr>
                            <td class="text-muted">本周挂号</td>
                            <td class="text-end fs-5 fw-bold text-info">{{ stats.week_registrations }}</td>
                        </tr>
                        <tr class="table-active bg-primary-subtle">
                            <td class="fw-bold text-primary-emphasis">今日挂号</td>
                            <td class="text-end fs-4 fw-bold text-primary">{{ stats.today_registrations }}</td>
                        </tr>
                    </tbody>
                </table>
            </div>
        </div>
    </div>

    <div class="col-md-6">
        <div class="card shadow-sm border-0 h-100">
            <div class="card-header bg-white pt-3 pb-2 border-bottom-0">
                <h5 class="fw-bold text-success mb-0"><i class="bi bi-file-medical-fill me-2"></i>处方统计</h5>
            </div>
            <div class="card-body pt-0">
                <table class="table table-hover align-middle mb-0">
                    <tbody>
                        <tr>
                            <td class="text-muted">总处方数</td>
                            <td class="text-end fs-5 fw-bold text-dark">{{ stats.total_prescriptions }}</td>
                        </tr>
                        <tr>
                            <td class="text-muted">本月处方</td>
                            <td class="text-end fs-5 fw-bold text-success">{{ stats.month_prescriptions }}</td>
                        </tr>
                        <tr>
                            <td class="text-muted">本周处方</td>
                            <td class="text-end fs-5 fw-bold text-info">{{ stats.week_prescriptions }}</td>
                        </tr>
                        <tr class="table-active bg-success-subtle">
                            <td class="fw-bold text-success-emphasis">今日处方</td>
                            <td class="text-end fs-4 fw-bold text-success">{{ stats.today_prescriptions }}</td>
                        </tr>
                    </tbody>
                </table>
            </div>
        </div>
    </div>
</div>

<!-- 财务统计 -->
<div class="row mb-4 g-4">
    <div class="col-md-6">
        <div class="card shadow-sm border-0 h-100">
            <div class="card-header bg-white pt-3 pb-2 border-bottom-0">
                <h5 class="fw-bold text-info mb-0"><i class="bi bi-currency-dollar me-2"></i>收入统计</h5>
            </div>
            <div class="card-body pt-0">
                <table class="table table-hover align-middle mb-0">
                    <tbody>
                        <tr>
                            <td class="text-muted">总收入</td>
                            <td class="text-end fs-5 fw-bold text-dark">¥{{ "%.2f"|format(stats.total_revenue) }}</td>
                        </tr>
                        <tr>
                            <td class="text-muted">本月收入</td>
                            <td class="text-end fs-5 fw-bold text-info">¥{{ "%.2f"|format(stats.month_revenue) }}</td>
                        </tr>
                        <tr>
                            <td class="text-muted">本周收入</td>
                            <td class="text-end fs-5 fw-bold text-primary">¥{{ "%.2f"|format(stats.week_revenue) }}</td>
                        </tr>
                        <tr class="table-active bg-info-subtle">
                            <td class="fw-bold text-info-emphasis">今日收入</td>
                            <td class="text-end fs-4 fw-bold text-info">¥{{ "%.2f"|format(stats.today_revenue) }}</td>
                        </tr>
                    </tbody>
                </table>
            </div>
        </div>
    </div>

    <div class="col-md-6">
        <div class="card shadow-sm border-0 h-100">
            <div class="card-header bg-white pt-3 pb-2 border-bottom-0">
                <h5 class="fw-bold text-primary mb-0"><i class="bi bi-bag-check-fill me-2"></i>取药统计</h5>
            </div>
            <div class="card-body d-flex flex-column justify-content-center">
                <div class="row text-center mb-4">
                    <div class="col-4 border-end">
                        <h3 class="fw-bold text-dark mb-0">{{ stats.total_pickups }}</h3>
                        <small class="text-muted text-uppercase">总票单</small>
                    </div>
                    <div class="col-4 border-end">
                        <h3 class="fw-bold text-success mb-0">{{ stats.completed_pickups }}</h3>
                        <small class="text-muted text-uppercase">已取药</small>
                    </div>
                    <div class="col-4">
                        <h3 class="fw-bold text-warning mb-0">{{ stats.pending_pickups }}</h3>
                        <small class="text-muted text-uppercase">待取药</small>
                    </div>
                </div>

                <h6 class="text-muted small mb-2">完成率</h6>
                <div class="progress" style="height: 20px;">
                    <div class="progress-bar bg-success progress-bar-striped progress-bar-animated" role="progressbar"
                        style="width: {{ stats.pickup_rate }}%;" aria-valuenow="{{ stats.pickup_rate }}"
                        aria-valuemin="0" aria-valuemax="100">
                        {{ "%.1f"|format(stats.pickup_rate) }}%
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- 库存预警 -->
{% if low_stock_drugs %}
<div class="card shadow-sm border-0 mb-4 border-start border-danger border-5">
    <div class="card-header bg-white pt-3 pb-2 border-bottom-0">
        <h5 class="fw-bold text-danger mb-0"><i class="bi bi-exclamation-triangle-fill me-2"></i>库存不足警告</h5>
    </div>
    <div class="card-body pt-0">
        <p class="text-muted small mb-3">以下药品库存低于10个，请及时补货：</p>
        <div class="table-responsive">
            <table class="table table-sm align-middle table-hover">
                <thead class="table-light">
                    <tr>
                        <th>药品名称</th>
                        <th class="text-end">当前库存</th>
                    </tr>
                </thead>
                <tbody>
                    {% for drug in low_stock_drugs %}
                    <tr>
                        <td class="fw-medium text-danger">{{ drug[1] }}</td>
                        <td class="text-end">
                            <span class="badge bg-danger rounded-pill">{{ drug[2] }}</span>
                        </td>
                    </tr>
                    {% endfor %}
                </tbody>
            </table>
        </div>
    </div>
</div>
{% endif %}

<!-- 科室统计 -->
<div class="row mb-4">
    <div class="col-md-12">
        <div class="card shadow-sm border-0">
            <div class="card-header bg-white pt-3 pb-2 border-bottom-0">
                <h5 class="fw-bold text-dark mb-0"><i class="bi bi-building me-2"></i>各科室挂号统计</h5>
            </div>
            <div class="card-body">
                {% if dept_stats %}
                <div class="table-responsive">
                    <table class="table table-hover align-middle">
                        <thead class="table-light">
                            <tr>
                                <th>科室名称</th>
                                <th class="text-end">挂号人数</th>
                                <th class="text-end" style="width: 15%;">占比</th>
                                <th style="width: 40%;">可视化</th>
                            </tr>
                        </thead>
                        <tbody>
                            {% for dept in dept_stats %}
                            <tr>
                                <td class="fw-bold">{{ dept[0] }}</td>
                                <td class="text-end">{{ dept[1] }}</td>
                                <td class="text-end text-muted">{{ "%.1f"|format(dept[2]) }}%</td>
                                <td>
                                    <div class="progress" style="height: 10px;">
                                        <div class="progress-bar bg-primary" role="progressbar"
                                            style="width: {{ dept[2] }}%;" aria-valuenow="{{ dept[2] }}"
                                            aria-valuemin="0" aria-valuemax="100">
                                        </div>
                                    </div>
                                </td>
                            </tr>
                            {% endfor %}
                        </tbody>
                    </table>
                </div>
                {% else %}
                <div class="alert alert-light text-center mb-0">暂无科室统计数据</div>
                {% endif %}
            </div>
        </div>
    </div>
</div>

<div class="row mb-4 g-4">
    <!-- 医生工作量统计 -->
    <div class="col-lg-6">
        <div class="card shadow-sm border-0 h-100">
            <div class="card-header bg-white pt-3 pb-2 border-bottom-0">
                <h5 class="fw-bold text-dark mb-0"><i class="bi bi-person-check-fill me-2"></i>医生工作量 Top 10</h5>
            </div>
            <div class="card-body p-0">
                {% if doctor_stats %}
                <div class="table-responsive">
                    <table class="table table-hover align-middle mb-0">
                        <thead class="table-light">
                            <tr>
                                <th class="ps-3">排名</th>
                                <th>医生</th>
                                <th class="text-end">处方数</th>
                                <th class="text-end pe-3">挂号数</th>
                            </tr>
                        </thead>
                        <tbody>
                            {% for doctor in doctor_stats %}
                            <tr>
                                <td class="ps-3">
                                    {% if loop.index == 1 %}
                                    <i class="bi bi-trophy-fill text-warning"></i> 1
                                    {% elif loop.index == 2 %}
                                    <i class="bi bi-trophy-fill text-secondary"></i> 2
                                    {% elif loop.index == 3 %}
                                    <i class="bi bi-trophy-fill text-danger"></i> 3
                                    {% else %}
                                    <span class="text-muted">{{ loop.index }}</span>
                                    {% endif %}
                                </td>
                                <td>
                                    <div class="fw-bold">{{ doctor[0] }}</div>
                                    <small class="text-muted">{{ doctor[1] }}</small>
                                </td>
                                <td class="text-end fw-bold text-success">{{ doctor[2] }}</td>
                                <td class="text-end text-muted pe-3">{{ doctor[3] }}</td>
                            </tr>
                            {% endfor %}
                        </tbody>
                    </table>
                </div>
                {% else %}
                <div class="alert alert-light text-center m-3">暂无医生工作量数据</div>
                {% endif %}
            </div>
        </div>
    </div>

    <!-- 热门药品统计 -->
    <div class="col-lg-6">
        <div class="card shadow-sm border-0 h-100">
            <div class="card-header bg-white pt-3 pb-2 border-bottom-0">
                <h5 class="fw-bold text-dark mb-0"><i class="bi bi-trophy-fill me-2"></i>热门药品 Top 10</h5>
            </div>
            <div class="card-body p-0">
                {% if popular_drugs %}
                <div class="table-responsive">
                    <table class="table table-hover align-middle mb-0">
                        <thead class="table-light">
                            <tr>
                                <th class="ps-3">排名</th>
                                <th>药品</th>
                                <th class="text-end">次数</th>
                                <th class="text-end pe-3">总额</th>
                            </tr>
                        </thead>
                        <tbody>
                            {% for drug in popular_drugs %}
                            <tr>
                                <td class="ps-3">
                                    {% if loop.index == 1 %}
                                    <span class="badge bg-warning text-dark pill">1</span>
                                    {% elif loop.index == 2 %}
                                    <span class="badge bg-secondary pill">2</span>
                                    {% elif loop.index == 3 %}
                                    <span class="badge bg-danger pill">3</span>
                                    {% else %}
                                    <span class="badge bg-light text-dark border pill">{{ loop.index }}</span>
                                    {% endif %}
                                </td>
                                <td>
                                    <div class="fw-bold text-truncate" style="max-width: 150px;">{{ drug[0] }}</div>
                                </td>
                                <td class="text-end">{{ drug[1] }}</td>
                                <td class="text-end fw-bold text-primary pe-3">¥{{ "%.0f"|format(drug[4]) }}</td>
                            </tr>
                            {% endfor %}
                        </tbody>
                    </table>
                </div>
                {% else %}
                <div class="alert alert-light text-center m-3">暂无药品销售数据</div>
                {% endif %}
            </div>
        </div>
    </div>
</div>

{% endblock %}